import unittest
import json

from app import app

class TestUser(unittest.TestCase):
    def setUp(self):
        self.client = app.test_client(self)
        
    def test_successful_signup(self):
        """Tests that a user can be signed in"""
        
        response = self.client.post('api/v1/auth/signup',content_type='application/json',
                                   data =json.dumps( dict(email='you@gmail.com',
                                                        password='lantern')))
        self.assertIn(u"Successfully signed up",response.data)
        self.assertEqual(response.status_code, 201)

    def test_unique_user_signup(self):
        """Tests that a unique user can be added"""
        self.client.post('api/v1/auth/signup',content_type='application/json',
                                   data =json.dumps( dict(email='me@gmail.com',
                                                        password='lantern')))
        response = self.client.post('api/v1/auth/signup',content_type='application/json',
                                   data =json.dumps( dict(email='me@gmail.com',
                                                        password='lantern')))
        self.assertIn(u"User already exists",response.data)
        self.assertEqual(response.status_code, 401)

    def test_wrong_format_credentials_signup(self):
        """Tests that a user cannot be added with wrong email format"""
        
        response = self.client.post('api/v1/auth/signup',content_type='application/json',
                                   data =json.dumps( dict(email='you@@gmail.com',
                                                        password='lantern')))
        result = json.loads(response.data.decode())
        self.assertEqual(result['message'], u'''Repetition of "@" is not allowed''')
        self.assertEqual(response.status_code, 422)

    def test_correct_credential_login(self):
        self.client.post('api/v1/auth/signup',content_type='application/json',
                                   data =json.dumps( dict(email='me@gmail.com',
                                                        password='lantern')))
        login = self.client.post('api/v1/auth/login',content_type='application/json',
                                   data =json.dumps( dict(email='me@gmail.com',
                                                        password='lantern')))
        result = json.loads(login.data.decode())
        self.assertIn(u'token',result)
        self.assertEqual(login.status_code, 200)

    

if __name__=="__main__":
    unittest.main()